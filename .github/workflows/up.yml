name: Auto Update Worker

on:
  push:
    branches:
      - main
  schedule:
    # æ¯å¤©åˆå¤œ (UTC) è¿è¡Œä¸€æ¬¡
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–° (å¿½ç•¥å†…å®¹å“ˆå¸Œæ£€æŸ¥)'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      REPO_OWNER: "bia-pain-bache"
      REPO_NAME: "BPB-Worker-Panel"
      TARGET_FILE: "worker.zip"
    outputs:
      updated: ${{ steps.check_update_step.outputs.updated }}
      new_tag: ${{ steps.check_update_step.outputs.remote_tag }}

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: æ£€æŸ¥å¹¶æ›´æ–° Worker (åŸºäºæ–‡ä»¶å“ˆå¸Œ)
        id: check_update_step
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail # ä»»ä½•å‘½ä»¤å¤±è´¥åˆ™ç«‹å³é€€å‡º

          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

          log "å¼€å§‹åŸºäºæ–‡ä»¶å“ˆå¸Œæ£€æŸ¥æ›´æ–°..."
          # è®¾å®šé»˜è®¤è¾“å‡º
          echo "updated=false" >> $GITHUB_OUTPUT
          echo "remote_tag=N/A" >> $GITHUB_OUTPUT
          echo "release_notes=No new release notes." >> $GITHUB_OUTPUT

          # --- 1. è·å–æœ€æ–° Release çš„ä¿¡æ¯ ---
          LATEST_RELEASE_URL="https://api.github.com/repos/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}/releases/latest"
          log "è·å–æœ€æ–° Release ä¿¡æ¯ Ø§Ø²: $LATEST_RELEASE_URL"

          RESPONSE=$(curl -s --retry 3 -L \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "$LATEST_RELEASE_URL")

          if echo "$RESPONSE" | jq -e '.message' > /dev/null; then
            log "ERROR: GitHub API è¿”å›é”™è¯¯: $(echo "$RESPONSE" | jq -r '.message')"
            exit 1
          fi

          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.assets[] | select(.name == "'"$TARGET_FILE"'") | .browser_download_url')
          REMOTE_TAG_FOR_LOG=$(echo "$RESPONSE" | jq -r '.tag_name')

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            log "ERROR: åœ¨æœ€æ–° Release ($REMOTE_TAG_FOR_LOG) ä¸­æœªæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶ '$TARGET_FILE'"
            exit 1
          fi

          # --- 2. æ¯”è¾ƒæ–‡ä»¶å“ˆå¸Œå€¼ ---
          LOCAL_HASH=""
          if [ -f "${{ env.TARGET_FILE }}" ]; then
            LOCAL_HASH=$(sha256sum "${{ env.TARGET_FILE }}" | awk '{print $1}')
            log "æœ¬åœ°æ–‡ä»¶å“ˆå¸Œ: $LOCAL_HASH"
          else
            log "æœ¬åœ°æ–‡ä»¶ '${{ env.TARGET_FILE }}' ä¸å­˜åœ¨ï¼Œå°†ç›´æ¥ä¸‹è½½ã€‚"
          fi

          REMOTE_TEMP_FILE=$(mktemp)
          wget --quiet -O "$REMOTE_TEMP_FILE" "$DOWNLOAD_URL"
          REMOTE_HASH=$(sha256sum "$REMOTE_TEMP_FILE" | awk '{print $1}')
          log "è¿œç¨‹æ–‡ä»¶å“ˆå¸Œ: $REMOTE_HASH"

          # --- 3. åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–° ---
          FORCE_UPDATE="${{ github.event.inputs.force_update || 'false' }}"
          log "å¼ºåˆ¶æ›´æ–°: $FORCE_UPDATE"

          if [ "$LOCAL_HASH" = "$REMOTE_HASH" ] && [ "$FORCE_UPDATE" != "true" ]; then
            log "æ–‡ä»¶å†…å®¹æœªå‘ç”Ÿå˜åŒ– (å“ˆå¸Œå€¼ç›¸åŒ)ï¼Œæ— éœ€æ›´æ–°ã€‚"
            rm "$REMOTE_TEMP_FILE"
            exit 0
          fi

          # --- 4. æ‰§è¡Œæ›´æ–° ---
          if [ "$FORCE_UPDATE" = "true" ]; then
            log "å¼ºåˆ¶æ›´æ–°å·²è§¦å‘ã€‚"
          else
            log "æ£€æµ‹åˆ°æ–‡ä»¶å†…å®¹æ›´æ–° (å“ˆå¸Œå€¼ä¸åŒ)ã€‚"
          fi

          log "æ­£åœ¨ç”¨æ–°æ–‡ä»¶æ›¿æ¢æ—§æ–‡ä»¶..."
          mv "$REMOTE_TEMP_FILE" "${{ env.TARGET_FILE }}"

          log "è§£å‹ ${{ env.TARGET_FILE }}..."
          unzip -o "${{ env.TARGET_FILE }}"

          # --- 5. è®¾ç½®è¾“å‡ºï¼Œä¾›æäº¤æ­¥éª¤ä½¿ç”¨ ---
          log "æ›´æ–°å®Œæˆï¼æ­£åœ¨å‡†å¤‡æäº¤ä¿¡æ¯..."
          REMOTE_TAG=$(echo "$RESPONSE" | jq -r '.tag_name')
          RELEASE_NOTES=$(echo "$RESPONSE" | jq -r '.body')

          echo "updated=true" >> $GITHUB_OUTPUT
          echo "remote_tag=$REMOTE_TAG" >> $GITHUB_OUTPUT

          # ä½¿ç”¨ Heredoc æ ¼å¼å®‰å…¨åœ°ä¼ é€’å¤šè¡Œçš„ Release Notes
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        if: steps.check_update_step.outputs.updated == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            ğŸ”„ è‡ªåŠ¨åŒæ­¥ Worker è‡³ ${{ steps.check_update_step.outputs.remote_tag }}

            ${{ steps.check_update_step.outputs.release_notes }}
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          file_pattern: .
